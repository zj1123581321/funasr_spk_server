# 项目目标

请用 python 写一个项目，使用 funasr 封装成一个 api，可以转录外部的音视频文件，生成区分说话人的带时间戳转录文本。

## API 设计
- 音视频时长可能数小时，转录时长可能或长或短。所以需要保证 api 链接的持续性（ws 协议？可能 http 不行）
    - 需要额外考虑大文件的上传方法
    - 无需实时返回转录结果，但最好可以展示进度。
- 需要支持多个转录任务同时进行，默认 4 个，尽量榨干机器的性能。
- 最长等待时间为 30min，可以在 config 里更改。

## 跨平台兼容性
- 需要同时支持在 windows、mac arm 系列、docker 上运行
- 支持音频、视频多种格式，如需要可以安装 ffmpeg （需要打包进 docker 镜像）。
- 无需考虑 GPU 加速，纯 cpu 运行。

## 输出格式
- 时间戳精确到秒级即可。
- 输出格式使用 json，区分说话人。
- 说话人标识使用 Speaker1、Speaker2 这种模式。

## 功能细节
- 过程中的错误或者其他信息可以通过企微机器人进行通知。自动重试 2 次。
- 转录完成后删除文件，但是保留文本缓存转录结果，相同文件直接返回，用 sqlite 数据库缓存。（但可以通过参数强制刷新）

## 日志系统
- 避免日志过大，本地文件。

## 访问控制
- 需要进行鉴权操作

## 配置管理
- 配置文件使用 config.json 

## 测试文件
- 存放于 @samples 文件夹里。有 wav,mp3,mp4。需要先验证 funasr 转录正常再对外架设客户端暴露 api。

# Funasr 

文档相对位置 @docs\funasr readme.md

## 模型介绍

文档地址：

使用 `Jieer2024/speech_paraformer-large-vad-punc-spk_asr_nat-zh-cn-onnx` 模型，提升效率。模型后续可以切换，所以写在 config 里。
模型文件下载到  `models/模型名` 对应的文件夹里。（docker 的话需要对外映射）


## 2050808 尝试修复 python 下在 vad 并发错误问题

【BUG】并发请求时 VAD报错：IndexError: list index out of range · Issue #865 · modelscope/FunASR: https://github.com/modelscope/FunASR/issues/865

当前的 server 在 cpu 本地并发运行是会报错：“list index out of range”,我在 github 看到的解答方案意思是：Python 版本的 VAD（语音活动检测）不支持同时处理多个请求。如果你想要同时使用 VAD（语音活动检测），可以参考支持并发 VAD 处理的 C++运行时。

参考代码 @docs\funasr python 并发错误问题\funasr-onnx-offline-vad.cpp

请尝试参考代码修改项目，使项目支持并发？