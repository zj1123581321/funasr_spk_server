# MPS 加速方案实施总结

实施日期：2025-10-09
目标：为 FunASR 转录服务添加 Apple Silicon GPU (MPS) 加速支持

---

## 一、实施内容

### 1. 架构设计

采用**统一设备管理架构**，支持多种加速后端（当前实现 MPS 和 CPU，预留 CUDA、ROCm、XPU 扩展接口）

#### 核心模块
```
src/core/
  ├── device_manager.py          # 统一设备检测和选择
  ├── patches/                   # 各后端补丁目录
  │   ├── __init__.py
  │   └── mps_patch.py          # MPS 设备补丁
  ├── funasr_transcriber.py     # 集成设备管理（lock 模式）
  └── worker_process.py         # 集成设备管理（pool 模式）
```

### 2. 配置文件更新

`config.json` 新增配置项：
```json
{
  "funasr": {
    "device": "auto",                      // "auto" | "mps" | "cpu"
    "device_priority": ["mps", "cpu"],     // 设备选择优先级
    "fallback_on_error": true,             // 设备初始化失败时自动回退
    ...
  }
}
```

#### 配置说明
- `device: "auto"` - 自动检测并选择最优设备
- `device: "mps"` - 强制使用 MPS（不可用时根据 fallback_on_error 决定）
- `device: "cpu"` - 强制使用 CPU
- `device_priority` - 自定义设备选择优先级
- `fallback_on_error` - 错误时是否自动回退到 CPU

---

## 二、核心实现

### 1. DeviceManager 设备管理器

**功能：**
- 自动检测可用设备（MPS、CPU）
- 根据配置选择最优设备
- 应用设备特定的补丁
- 提供设备信息查询和日志

**关键方法：**
```python
DeviceManager.detect_available_devices()  # 检测可用设备
DeviceManager.select_device(config)       # 选择设备
DeviceManager.apply_patches(device)       # 应用补丁
DeviceManager.get_device_info(device)     # 获取设备信息
```

### 2. MPS 补丁模块

**位置：** `src/core/patches/mps_patch.py`

**功能：**
- 修复 FunASR 的 AutoModel.build_model 方法
- 添加 MPS 设备支持（原始代码强制回退到 CPU）
- 支持多进程环境下的 MPS 使用

**关键修改：**
```python
# 原始 FunASR 逻辑
if not torch.cuda.is_available():
    device = "cpu"  # 强制 CPU

# 修改后的逻辑
if device == "cuda" and not torch.cuda.is_available():
    if torch.backends.mps.is_available():
        device = "mps"  # 优先 MPS
    else:
        device = "cpu"
```

### 3. Pool 模式集成

**修改文件：** `src/core/worker_process.py`

**集成点：** Worker 进程初始化时
```python
def worker_loop(worker_id, config_path, task_dir):
    config = load_config(config_path)

    # 1. 设置设备并应用补丁
    device = setup_device(config)

    # 2. 初始化模型（使用选定的设备）
    model = initialize_model(config, device)

    # 3. 处理任务...
```

**关键点：**
- 每个 worker 进程独立检测和初始化设备
- MPS 在多进程下，每个进程有独立的 GPU 上下文
- 补丁在 worker 进程中应用，不在主进程

### 4. Lock 模式集成

**修改文件：** `src/core/funasr_transcriber.py`

**集成点：** 主进程初始化时
```python
async def initialize(self):
    if self.concurrency_mode == "lock":
        # 设备管理
        device = DeviceManager.select_device(self.config)
        DeviceManager.apply_patches(device)
        DeviceManager.log_device_selection(device, self.config)

        # 初始化模型
        self.model = AutoModel(..., device=device)
```

---

## 三、测试结果

### 测试环境
- 设备：Apple Silicon Mac
- 音频：31.5 分钟（1892.91 秒）
- 说话人数量：2 人

### 性能对比

| 模式 | 设备 | 推理时间 | RTF | 速度倍率 | 相对加速 |
|------|------|----------|-----|----------|----------|
| 测试脚本 | CPU | 384.79秒 | 0.2033 | 4.92x | 1.00x |
| 测试脚本 | MPS | 92.88秒 | 0.0491 | 20.38x | **4.14x** |
| Pool 模式 | MPS | 95.67秒 | 0.0505 | 19.79x | **4.02x** |

### 功能验证
✅ **说话人识别正常**
- 识别出 2 个说话人
- Speaker1: 29 个片段
- Speaker2: 28 个片段

✅ **多进程支持**
- Worker 进程成功检测和使用 MPS
- 进程池初始化正常（约 8 秒）
- 转录结果准确

✅ **自动设备选择**
- 自动检测 MPS 可用性
- 按优先级选择设备
- 日志清晰记录设备信息

---

## 四、使用方式

### 1. 自动模式（推荐）
```json
{
  "funasr": {
    "device": "auto"  // 自动检测，MPS 优先
  }
}
```

### 2. 强制 MPS
```json
{
  "funasr": {
    "device": "mps"  // 强制使用 MPS
  }
}
```

### 3. 强制 CPU
```json
{
  "funasr": {
    "device": "cpu"  // 强制使用 CPU
  }
}
```

### 4. 自定义优先级
```json
{
  "funasr": {
    "device": "auto",
    "device_priority": ["mps", "cpu"]  // 自定义优先级
  }
}
```

---

## 五、架构优势

### 1. 模块化设计
- 设备管理与业务逻辑分离
- 补丁模块独立，易于维护
- 新增设备类型只需添加对应补丁模块

### 2. 灵活配置
- 支持自动检测和手动指定
- 支持自定义优先级
- 支持错误回退

### 3. 多并发模式支持
- Lock 模式：主进程统一管理
- Pool 模式：每个 worker 独立管理
- 两种模式实现一致性

### 4. 扩展性
未来添加其他加速方案只需：
```python
# 1. 创建补丁模块
src/core/patches/cuda_patch.py
src/core/patches/rocm_patch.py
src/core/patches/xpu_patch.py

# 2. 在 DeviceManager 中添加检测逻辑
def detect_available_devices():
    if torch.cuda.is_available():
        available.append("cuda")
    # ...
```

**零侵入，完全模块化！**

---

## 六、性能收益

### 1. 转录速度
- CPU 模式：6.4 分钟处理 31 分钟音频
- MPS 模式：1.6 分钟处理 31 分钟音频
- **提升约 4 倍**

### 2. 实时因子 (RTF)
- CPU: 0.203（每处理 1 秒音频需要 0.203 秒）
- MPS: 0.050（每处理 1 秒音频需要 0.050 秒）
- **提升约 4 倍**

### 3. 吞吐量
- 相同时间内可处理 4 倍的音频量
- 或者相同音频量，处理时间减少 75%

---

## 七、注意事项

### 1. 设备兼容性
- MPS 需要 Apple Silicon（M1/M2/M3 芯片）
- macOS 12.3+ 系统
- PyTorch 需支持 MPS

### 2. 内存管理
- MPS 与 CPU 共享内存
- 注意控制并发数量，避免 OOM
- Pool 模式下每个 worker 有独立的 GPU 上下文

### 3. 首次初始化
- 模型首次加载需要下载，时间较长
- Worker 进程初始化约需 8-10 秒
- 建议预热模型

### 4. 错误处理
- 设备初始化失败会自动回退 CPU
- 详细错误信息记录在日志中
- 可通过 fallback_on_error 控制行为

---

## 八、文件清单

### 新增文件
- `src/core/device_manager.py` - 设备管理器
- `src/core/patches/__init__.py` - 补丁模块初始化
- `src/core/patches/mps_patch.py` - MPS 补丁
- `tests/performance/test_pool_mps.py` - Pool 模式测试
- `tests/performance/test_mps_quick.py` - 快速测试脚本

### 修改文件
- `config.json` - 添加设备配置
- `src/core/funasr_transcriber.py` - 集成设备管理（lock 模式）
- `src/core/worker_process.py` - 集成设备管理（pool 模式）

### 文档文件
- `docs/cc history/2025-10-09-完整流程 MPS 加速测试结果.md`
- `docs/cc history/2025-10-09-MPS加速方案实施总结.md`（本文档）

---

## 九、后续优化建议

### 1. 性能监控
- 添加设备利用率监控
- 记录 RTF 统计信息
- 收集性能指标用于分析

### 2. 动态设备切换
- 支持运行时切换设备
- 根据负载动态选择设备

### 3. 批处理优化
- 研究 MPS 下的最优 batch_size
- 优化内存使用策略

### 4. 企微通知
- 设备切换时发送通知
- 性能异常时告警

---

## 十、总结

✅ **成功实现了统一的设备管理架构**
- 支持 MPS 和 CPU 两种模式
- 为未来扩展预留接口（CUDA、ROCm、XPU）

✅ **性能提升显著**
- MPS 相比 CPU 提升约 4 倍
- 19-20 倍实时速度处理

✅ **功能完整性**
- 说话人识别正常
- 转录结果准确
- 多进程支持良好

✅ **代码质量**
- 模块化设计
- 详细注释和文档
- 完善的错误处理

**建议：在 Mac 生产环境启用 MPS 加速，可显著提升转录性能。**

---

**实施完成日期：** 2025-10-09
**测试状态：** ✅ 通过
**建议部署：** ✅ 推荐生产环境使用
