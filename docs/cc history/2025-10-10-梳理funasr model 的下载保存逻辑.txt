
 ▐▛███▜▌   Claude Code v2.0.13
▝▜█████▛▘  Sonnet 4.5 · Claude Max
  ▘▘ ▝▝    D:\MyFolders\Developments\0GithubProjectsTest\250728_funasr\funasr_spk_server

> /clear 
  ⎿  (no content)

> @README.md 
数量项目,找出 FUNASR_MODEL_DIR 的使用方式，以及相关模型文件的保存逻辑和位置。特别是如果模型不存在，那么自动下载会下载到哪里？ 
  ⎿  Read README.md (522 lines)

● 我来帮你分析 FUNASR_MODEL_DIR 的使用方式和模型文件的保存逻辑。让我先搜索相关代码。

● Search(pattern: "FUNASR_MODEL_DIR")
  ⎿  Found 3 files (ctrl+o to expand)

● Search(pattern: "model.*dir")
  ⎿  Found 11 files (ctrl+o to expand)

● Search(pattern: "**/*.env*")
  ⎿  Found 0 files 

● Search(pattern: "**/config*.json")
  ⎿  Found 6 files (ctrl+o to expand)

● 现在让我读取关键文件来分析模型目录的使用：

● Read(.env.example)
  ⎿  Read 122 lines

● Read(config.json)
  ⎿  Read 107 lines

● Read(src\core\config.py)
  ⎿  Read 396 lines

● Read(src\core\funasr_transcriber.py)
  ⎿  Read 536 lines

● 现在让我搜索 FunASR 的 AutoModel 调用，看看模型下载的具体实现：

● Search(pattern: "AutoModel|cache_dir|model.*download")
  ⎿  Found 15 files (ctrl+o to expand)

● Read(src\core\worker_process.py)
  ⎿  Read 233 lines

● 现在让我查看实际的模型目录结构，了解模型文件是如何组织的：

● Bash(ls -la "D:\MyFolders\Developments\0GithubProjectsTest\250728_funasr\funasr_spk_server\models")
  ⎿  total 12                                   
     drwxr-xr-x 1 zlx 197121 0 Jul 29 20:33 ./
     drwxr-xr-x 1 zlx 197121 0 Oct 10 14:33 ../
     drwxr-xr-x 1 zlx 197121 0 Aug  8 12:03 hub/

● Bash(ls -la "D:\MyFolders\Developments\0GithubProjectsTest\250728_funasr\funasr_spk_server\models\hub")
  ⎿  total 4                                   
     drwxr-xr-x 1 zlx 197121 0 Aug  8 12:03 ./
     drwxr-xr-x 1 zlx 197121 0 Jul 29 20:33 ../
     … +2 lines (ctrl+o to expand)

● Bash(ls -la "D:\MyFolders\Developments\0GithubProjectsTest\250728_funasr\funasr_spk_server\models\hub\iic")
  ⎿  total 24                                  
     drwxr-xr-x 1 zlx 197121 0 Jul 29 17:19 ./
     drwxr-xr-x 1 zlx 197121 0 Aug  8 12:03 ../
     … +5 lines (ctrl+o to expand)

● 现在让我搜索 FunASR 库的文档或查看如何处理模型下载：

● Search(pattern: "disable_update", output_mode: "content")
  ⎿  Found 159 lines (ctrl+o to expand)

● Read(docs\funasr相关\funasr readme.md)
  ⎿  Read 398 lines

● 现在让我检查 FunASR 的 Python 包是否有关于模型下载路径的文档：

● Bash(python -c "import funasr; print(funasr.__file__); print(funasr.__version__)")
  ⎿  C:\Users\zlx\AppData\Local\Programs\Python\Python311\Lib\site-packages\funasr\__init__.py
     1.2.6

● 让我创建一个测试脚本来验证模型下载的行为：

● Bash(cd "D:\MyFolders\Developments\0GithubProjectsTest\250728_funasr\funasr_spk_server" && python -c "from funasr import AutoModel;
      import os; help(AutoModel.__init_…)
  ⎿  Help on function __init__ in module funasr.auto.auto_model:       

     __init__(self, **kwargs)
         Initialize self.  See help(type(self)) for accurate signature.

● 基于我对代码的分析,我现在可以为你提供完整的答案了。让我整理成文档:

  FUNASR_MODEL_DIR 使用方式和模型文件保存逻辑分析

  1. FUNASR_MODEL_DIR 的配置路径

  FUNASR_MODEL_DIR 环境变量的配置遵循以下优先级：

  环境变量 (.env) > config.json > 代码默认值

  配置文件位置：

  .env.example (第45行):
  FUNASR_MODEL_DIR=./models

  config.json (第45行注释):
  "_comment_model_dir": "模型目录请在 .env 中配置: FUNASR_MODEL_DIR"

  src/core/config.py (第39行):
  class FunASRConfig(BaseModel):
      model_dir: str = "./models"  # 默认值

  2. 模型文件的使用位置

  FUNASR_MODEL_DIR 在以下三个关键位置被使用：

  a) funasr_transcriber.py (第116行)

  self.model = AutoModel(
      model=funasr_config["model"],
      model_revision=funasr_config["model_revision"],
      vad_model=funasr_config["vad_model"],
      vad_model_revision=funasr_config["vad_model_revision"],
      punc_model=funasr_config["punc_model"],
      punc_model_revision=funasr_config["punc_model_revision"],
      spk_model=funasr_config["spk_model"],
      spk_model_revision=funasr_config["spk_model_revision"],
      cache_dir=self.cache_dir,  # ← 这里使用模型目录
      ncpu=funasr_config.get("ncpu", 8),
      device=device,
      disable_update=funasr_config.get("disable_update", True),
      disable_pbar=funasr_config.get("disable_pbar", True)
  )

  b) worker_process.py (第68-82行)

  def initialize_model(device: str):
      funasr_config = global_config.funasr
      cache_dir = funasr_config.model_dir  # ← 从全局配置获取
      Path(cache_dir).mkdir(parents=True, exist_ok=True)  # 确保目录存在

      model = AutoModel(
          cache_dir=cache_dir,  # ← 传递给FunASR
          # ... 其他参数
      )

  3. 模型文件的自动下载逻辑

  下载行为分析：

  FunASR 的 AutoModel 类使用 cache_dir 参数来指定模型缓存位置。如果模型不存在，会自动从 ModelScope 或 HuggingFace 下载。

  关键参数：
  - cache_dir: 指定模型缓存目录（对应 FUNASR_MODEL_DIR）
  - disable_update=True: 禁用模型更新（项目默认配置）
  - model_hub: 模型仓库选择（ms = ModelScope，hf = HuggingFace）

  实际下载位置：

  根据项目的文件系统结构：

  funasr_spk_server/
  └── models/                           ← FUNASR_MODEL_DIR (默认 ./models)
      └── hub/                          ← FunASR 自动创建
          └── iic/                      ← ModelScope 组织名
              ├── speech_seaco_paraformer_large_asr_nat-zh-cn-16k-common-vocab8404-pytorch/
              ├── speech_fsmn_vad_zh-cn-16k-common-pytorch/
              ├── speech_campplus_sv_zh-cn_16k-common/
              ├── speech_paraformer-large-vad-punc_asr_nat-zh-cn-16k-common-vocab8404-pytorch/
              └── punc_ct-transformer_zh-cn-common-vocab272727-pytorch/

  4. 下载目录的完整路径推导

  如果 FUNASR_MODEL_DIR=./models，那么：

  1. 基础目录: ./models
  2. Hub 目录: ./models/hub (FunASR 自动创建)
  3. 组织目录: ./models/hub/iic (ModelScope 组织)
  4. 模型目录: ./models/hub/iic/{model_name}/

  示例模型完整路径：
  ./models/hub/iic/speech_paraformer-large-vad-punc_asr_nat-zh-cn-16k-common-vocab8404-pytorch/
  ├── configuration.json
  ├── model.pt
  ├── vocab.txt
  └── ... (其他模型文件)

  5. 模型配置详情

  项目使用的模型配置 (config.json):

  {
    "funasr": {
      "model": "paraformer-zh",              // 主模型简称
      "model_revision": "v2.0.4",            // 版本
      "vad_model": "fsmn-vad",               // VAD模型
      "vad_model_revision": "v2.0.4",
      "punc_model": "ct-punc-c",             // 标点模型
      "punc_model_revision": "v2.0.4",
      "spk_model": "cam++",                  // 说话人识别模型
      "spk_model_revision": "v2.0.2"
    }
  }

  这些简称会被 FunASR 自动映射到完整的 ModelScope 模型路径。

  6. 模型下载的触发条件

  模型会在以下情况自动下载：

  1. 首次运行: cache_dir 目录不存在或为空
  2. 模型缺失: 指定版本的模型文件不存在
  3. 更新模式: disable_update=False 时（本项目默认为 True，不会自动更新）

  7. 自定义模型目录的方法

  方法1：环境变量 (推荐)

  编辑 .env 文件：
  FUNASR_MODEL_DIR=/path/to/your/models

  方法2：config.json

  {
    "funasr": {
      "model_dir": "/path/to/your/models"
    }
  }

  注意: 环境变量优先级更高，会覆盖 config.json 的配置。

  8. 目录创建和初始化

  在 src/core/config.py 的 setup_directories() 方法中（第383行）：

  def setup_directories(self):
      """创建必要的目录"""
      directories = [
          self.server.temp_dir,
          self.server.upload_dir,
          self.funasr.model_dir,  # ← 自动创建模型目录
          Path(self.database.path).parent,
          self.logging.log_dir
      ]

      for directory in directories:
          Path(directory).mkdir(parents=True, exist_ok=True)

  总结

  1. 默认路径: ./models
  2. 实际下载位置: ./models/hub/iic/{model_name}/
  3. 自动下载: 首次运行时自动从 ModelScope 下载（约2GB）
  4. 配置方式: 通过 .env 文件的 FUNASR_MODEL_DIR 环境变量
  5. 模型更新: 默认 disable_update=True，不会自动更新已下载的模型
  6. 目录创建: 服务器启动时自动创建，如果不存在



