# MPS 长音频故障与补丁方案

更新日期：2025-10-12  
适用范围：FunASR MPS 加速（pool 模式、lock 模式）

---

## 1. 问题概述
- 现象：转录时长 ≥60 分钟的音频在 MPS 设备上稳定触发 `Dimension specified as -1 but tensor has no dimensions`，任务失败。
- 触发链路：FunASR `AutoModel.generate()` → `seaco_paraformer/model.py::calc_predictor()` → `bicif_paraformer/cif_predictor.py::cif()`。
- 场景：`batch_size_s` 默认为 60 秒时仍会复现；长音频在 VAD 切分后的某些 chunk 进入 CIF 时崩溃。

## 2. 根因定位
- 对 `cif()` 内部张量进行钩子调试，发现所有 `torch.nonzero(fire >= threshold)` 索引长度正常（约 110），不存在空集合或 NaN。
- 将完全相同的 `hidden/alphas` 张量搬到 CPU 再执行 `cif()`，可以得到形状为 `[78, 44, 512]` 的结果，说明数据合法。
- 推断为 **PyTorch MPS 后端 `torch.index_select` 在大索引长度下的内核缺陷**：`frames[b]` 位于 `mps:0` 时崩溃，移动到 CPU 后成功。
- 调试日志留存：`logs/mps_long_audio_debug.log`。

## 3. 解决方案
1. **运行时补丁（已实现）**  
   - 在 `src/core/patches/mps_patch.py` 的 `apply_mps_patch()` 内追加 CIF 钩子：  
     - 默认仍尝试在 MPS 上执行；若捕获 `IndexError`/`RuntimeError`，自动将输入转至 CPU 执行并把结果搬回原设备。  
     - 避免修改第三方包源码，同时只在必要时回退，保持正常短音频的 MPS 性能。
2. **配置层建议**  
   - 长音频仍占用大量统一内存，建议保持 `batch_size_s`≤60 并限制 MPS 并发（≤2）以避免其他内核超时报错。
   - 可在任务调度层对超长音频启用 CPU 回退，作为双保险。

## 4. 补丁验证
- 补丁后执行 `python tests/diagnostics/test_mps_buffer_size_analysis.py`：65.5 分钟样本顺利完成，处理耗时约 135 秒，日志见终端记录。
- 长音频阶段 `cif()` 首次在 MPS 失败，自动回退 CPU 成功获得结果，不再触发异常。

## 5. 后续行动
- 将日志及最小复现脚本反馈给 PyTorch/FunASR 社区，协助修复 MPS `index_select` 缺陷。
- 观察补丁是否引入明显性能退化（当前仅在触发异常时短暂 CPU 运算，可忽略）。
- 若未来上游修复，可移除该临时补丁以恢复全链路 MPS 运行。
