# 完整流程 MPS 加速测试结果

测试日期：2025-10-09
测试目标：验证 Mac MPS 对完整转录流程（VAD + ASR + Speaker Diarization + Punctuation）的加速效果

## 测试配置

### 测试音频
- 文件：temp/test.m4a
- 时长：1892.91 秒（约 31.5 分钟）
- 说话人数量：2 个（主持人和嘉宾）

### 模型配置
- **VAD 模型**：fsmn-vad (v2.0.4)
- **ASR 模型**：paraformer-zh (v2.0.4)
- **说话人识别模型**：cam++ (v2.0.2)
- **标点恢复模型**：ct-punc-c (v2.0.4)

## 测试结果

### CPU 模式
| 指标 | 数值 |
|------|------|
| 推理时间 | 384.79 秒（约 6.4 分钟）|
| RTF | 0.2033 |
| 速度倍率 | 4.92x（比实时快 4.92 倍）|
| 模型初始化时间 | 4.69 秒 |
| 识别说话人数量 | 2 人 |
| 生成片段数量 | 822 个 |

### MPS 模式
| 指标 | 数值 |
|------|------|
| 推理时间 | 92.88 秒（约 1.5 分钟）|
| RTF | 0.0491 |
| 速度倍率 | 20.38x（比实时快 20.38 倍）|
| 模型初始化时间 | 5.94 秒 |
| 识别说话人数量 | 2 人 |
| 生成片段数量 | 822 个 |

### 性能对比
- **MPS 相比 CPU 提升：4.14x**
- **转录结果一致性：100%**（CPU 和 MPS 结果完全一致）
- **说话人识别准确性：正常**
  - Speaker1: 622 个片段
  - Speaker2: 200 个片段

## 说话人识别验证

### 示例片段
```
[22] 00:54.530 -> 00:55.790 | Speaker2
他是个玻璃天花板。

[30] 01:18.940 -> 01:19.740 | Speaker2
亲爱的听众朋友，

[31] 01:19.740 -> 01:20.260 | Speaker2
大家好，

[32] 01:20.280 -> 01:21.700 | Speaker2
欢迎收听本期的创业内幕。

[33] 01:21.700 -> 01:22.700 | Speaker2
我是主持人 lily。
```

说话人识别工作正常，能够准确区分主持人和嘉宾的对话。

## 结论

✅ **MPS 加速效果显著**
- 完整流程（包括说话人识别）加速 4.14 倍
- 从 6.4 分钟降低到 1.5 分钟
- 对于 31 分钟的音频，节省了约 5 分钟的处理时间

✅ **结果完全一致**
- CPU 和 MPS 转录结果完全相同
- 说话人识别结果完全一致
- 无精度损失

✅ **说话人识别功能正常**
- 成功识别 2 个说话人
- 时间戳准确
- 文本转录准确

## 建议

1. **生产环境启用 MPS**
   - 修改 `config.json`：设置 `"device": "mps"`
   - 应用 FunASR 源码补丁（见测试脚本输出）

2. **预期收益**
   - 转录速度提升 4 倍
   - 降低服务器处理延迟
   - 提高并发处理能力

3. **注意事项**
   - 确保 Mac 支持 MPS（M1/M2/M3 芯片）
   - 首次加载模型时间略长（约 6 秒）
   - 建议使用模型池模式以提高并发性能

## 测试文件输出

所有测试结果保存在 `tests/performance/output/` 目录：

- `transcription_cpu.json` - CPU 完整结果
- `transcription_cpu.txt` - CPU 纯文本
- `transcription_cpu_sentences.txt` - CPU 带时间戳和说话人信息
- `transcription_mps.json` - MPS 完整结果
- `transcription_mps.txt` - MPS 纯文本
- `transcription_mps_sentences.txt` - MPS 带时间戳和说话人信息

## 测试脚本

测试脚本位置：`tests/performance/test_mps_quick.py`

运行方式：
```bash
source venv/bin/activate
python tests/performance/test_mps_quick.py
```

---

**测试结论：MPS 加速对完整转录流程（包含说话人识别）有显著效果，强烈建议在 Mac 上启用。**
